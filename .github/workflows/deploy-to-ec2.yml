name: Deploy to AWS EC2 via SSM

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Compile and run GenerateHtml
      run: |
        echo "Compiling GenerateHtml.java..."
        javac GenerateHtml.java
        
        echo "Running GenerateHtml to create HTML file..."
        java GenerateHtml
        
        echo "Checking generated files:"
        ls -la *.html || echo "No HTML files found"

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ vars.AWS_ROLE_ARN }}
        aws-region: ap-southeast-5

    - name: Transfer HTML file to EC2 via SSM
      run: |
        if [ -f "index.html" ]; then
          echo "Transferring index.html to EC2 /opt directory..."
          
          # 读取HTML文件内容并base64编码
          HTML_CONTENT=$(base64 -w 0 index.html)
          
          # 通过SSM在EC2上重新创建HTML文件
          aws ssm send-command \
            --instance-ids "i-08b57244688e0e5b7" \
            --document-name "AWS-RunShellScript" \
            --parameters "commands=[
              'echo \"Deploying HTML file to /opt...\"',
              'sudo mkdir -p /opt',
              'echo \"$HTML_CONTENT\" | base64 -d > /opt/index.html',
              'sudo chmod 644 /opt/index.html',
              'echo \"HTML file deployed successfully\"',
              'ls -la /opt/index.html'
            ]" \
            --comment "Deploy generated HTML to EC2"
        else
          echo "No index.html file found to deploy"
          exit 1
        fi

    - name: Restart application via SSM
      run: |
        aws ssm send-command \
          --instance-ids "i-08b57244688e0e5b7" \
          --document-name "AWS-RunShellScript" \
          --parameters "commands=[
            'cd /path/to/your/app',
            'echo \"Restarting application...\"',
            'docker-compose down',
            'docker-compose up -d',
            'echo \"Deployment completed successfully!\"'
          ]" \
          --comment "Restart application after HTML deployment"
